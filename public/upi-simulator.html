<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPI Collect Flow Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            margin: 10px 0;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .result-item.error {
            border-left-color: #f44336;
        }

        .result-item h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .result-item pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 14px;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.loading {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upi-examples {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .upi-examples h4 {
            margin-bottom: 10px;
            color: #2e7d32;
        }

        .upi-examples ul {
            list-style: none;
            padding: 0;
        }

        .upi-examples li {
            padding: 5px 0;
            color: #388e3c;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ UPI Collect Flow Simulator</h1>
            <p>Test Paytm UPI payments with VPA validation</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('validation')">VPA Validation</button>
                <button class="tab" onclick="switchTab('payment')">Payment Flow</button>
                <button class="tab" onclick="switchTab('webhook')">Webhook Test</button>
            </div>

            <!-- VPA Validation Tab -->
            <div id="validation" class="tab-content active">
                <h3>üîç UPI ID Validation Test</h3>
                <p>Test if a UPI ID (VPA) is valid and exists</p>

                <div class="upi-examples">
                    <h4>üìã Test UPI IDs:</h4>
                    <ul>
                        <li><strong>Valid:</strong> 7388187060@ptaxis, 9856253545@ybl, test@paytm</li>
                        <li><strong>Invalid:</strong> invalid@nonexistent, 123@ybl, invalid-format</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label for="vpaInput">UPI ID (VPA):</label>
                    <input type="text" id="vpaInput" placeholder="e.g., 7388187060@ptaxis" value="7388187060@ptaxis">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="orderId">Order ID:</label>
                        <input type="text" id="orderId" value="f93051bc-0e13-46ad-94bb-ddd41426f26a">
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount (‚Çπ):</label>
                        <input type="number" id="amount" value="100" step="0.01">
                    </div>
                </div>

                <button class="btn" onclick="testVpaValidation()">
                    <span id="validationSpinner" class="loading-spinner hidden"></span>
                    Test VPA Validation
                </button>

                <div id="validationResults" class="results hidden"></div>
            </div>

            <!-- Payment Flow Tab -->
            <div id="payment" class="tab-content">
                <h3>üí≥ UPI Collect Flow Payment</h3>
                <p>Create a UPI Collect Flow payment intent</p>

                <div class="form-group">
                    <label for="paymentVpa">UPI ID (VPA):</label>
                    <input type="text" id="paymentVpa" placeholder="e.g., 7777777777@paytm" value="7777777777@paytm">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="paymentOrderId">Order ID:</label>
                        <input type="text" id="paymentOrderId" value="f93051bc-0e13-46ad-94bb-ddd41426f26a">
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">Amount (‚Çπ):</label>
                        <input type="number" id="paymentAmount" value="250" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="customerName">Customer Name:</label>
                    <input type="text" id="customerName" value="Test Customer">
                </div>

                <div class="form-group">
                    <label for="customerPhone">Customer Phone:</label>
                    <input type="text" id="customerPhone" value="7388187060">
                </div>

                <button class="btn" onclick="createPaymentIntent()">
                    <span id="paymentSpinner" class="loading-spinner hidden"></span>
                    Create Payment Intent
                </button>

                <div id="paymentResults" class="results hidden"></div>
            </div>

            <!-- Webhook Test Tab -->
            <div id="webhook" class="tab-content">
                <h3>üîó Paytm Webhook Test</h3>
                <p>Test Paytm webhook handling for UPI payments</p>

                <div class="form-group">
                    <label for="webhookOrderId">Order ID:</label>
                    <input type="text" id="webhookOrderId" value="ORDER_f93051bc-0e13-46ad-94bb-ddd41426f26a">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="webhookTxnId">Transaction ID:</label>
                        <input type="text" id="webhookTxnId" value="TXN_123456789">
                    </div>
                    <div class="form-group">
                        <label for="webhookAmount">Amount (‚Çπ):</label>
                        <input type="number" id="webhookAmount" value="250" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="webhookStatus">Status:</label>
                    <select id="webhookStatus">
                        <option value="TXN_SUCCESS">TXN_SUCCESS</option>
                        <option value="TXN_FAILURE">TXN_FAILURE</option>
                        <option value="PENDING">PENDING</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="webhookUpiId">UPI ID:</label>
                    <input type="text" id="webhookUpiId" value="7777777777@paytm">
                </div>

                <button class="btn btn-secondary" onclick="testWebhook()">
                    <span id="webhookSpinner" class="loading-spinner hidden"></span>
                    Test Webhook
                </button>

                <div id="webhookResults" class="results hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:3001';
        const API_PREFIX = 'api/v1';
        const JWT_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6Im5vdGhpbmdAbm90aGluZy5jb20iLCJzdWIiOiJkZGU5MDIwYS05MmQ4LTQ0NmMtYTRiNy0zYjFlZGQ3ZGE4OTMiLCJyb2xlIjoiVVNFUiIsImlhdCI6MTc1NzMwNzI0NCwiZXhwIjoxNzU3MzA4MTQ0fQ.KTfeDktMqrkumuWuA7j5yF9e58PQoyhNly8Rumh2ZdE';

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Show loading spinner
        function showSpinner(spinnerId) {
            document.getElementById(spinnerId).classList.remove('hidden');
        }

        // Hide loading spinner
        function hideSpinner(spinnerId) {
            document.getElementById(spinnerId).classList.add('hidden');
        }

        // Show results
        function showResults(resultsId, content) {
            const resultsDiv = document.getElementById(resultsId);
            resultsDiv.innerHTML = content;
            resultsDiv.classList.remove('hidden');
        }

        // Test VPA Validation
        async function testVpaValidation() {
            const vpa = document.getElementById('vpaInput').value;
            const orderId = document.getElementById('orderId').value;
            const amount = document.getElementById('amount').value;

            showSpinner('validationSpinner');

            try {
                const response = await fetch(`${API_BASE_URL}/${API_PREFIX}/payments/create-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: parseFloat(amount),
                        currency: 'INR',
                        paymentMethod: 'UPI',
                        provider: 'UPI',
                        upiId: vpa,
                        metadata: {
                            upiProvider: 'paytm'
                        }
                    })
                });

                const data = await response.json();
                
                let resultContent = '';
                if (response.ok) {
                    resultContent = `
                        <div class="result-item">
                            <h4><span class="status success">Success</span> VPA Validation Passed</h4>
                            <p><strong>UPI ID:</strong> ${vpa}</p>
                            <p><strong>Status:</strong> Valid UPI ID accepted</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultContent = `
                        <div class="result-item error">
                            <h4><span class="status error">Error</span> VPA Validation Failed</h4>
                            <p><strong>UPI ID:</strong> ${vpa}</p>
                            <p><strong>Error:</strong> ${data.message || 'Unknown error'}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }

                showResults('validationResults', resultContent);

            } catch (error) {
                const resultContent = `
                    <div class="result-item error">
                        <h4><span class="status error">Error</span> Network Error</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure your API server is running on ${API_BASE_URL}</p>
                    </div>
                `;
                showResults('validationResults', resultContent);
            } finally {
                hideSpinner('validationSpinner');
            }
        }

        // Create Payment Intent
        async function createPaymentIntent() {
            const vpa = document.getElementById('paymentVpa').value;
            const orderId = document.getElementById('paymentOrderId').value;
            const amount = document.getElementById('paymentAmount').value;
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;

            showSpinner('paymentSpinner');

            try {
                const response = await fetch(`${API_BASE_URL}/${API_PREFIX}/payments/create-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${JWT_TOKEN}`
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: parseFloat(amount),
                        currency: 'INR',
                        paymentMethod: 'UPI',
                        provider: 'UPI',
                        upiId: vpa,
                        metadata: {
                            upiProvider: 'paytm',
                            customerName: customerName,
                            customerPhone: customerPhone
                        }
                    })
                });

                const data = await response.json();
                
                let resultContent = '';
                if (response.ok) {
                    const paymentData = data.data;
                    const hasUPICollectData = paymentData.clientData && (
                        paymentData.clientData.upiId ||
                        paymentData.clientData.upiCollectFlow ||
                        paymentData.clientData.customerUpiId ||
                        paymentData.clientData.upiChannel === 'UPIPUSH'
                    );

                    if (hasUPICollectData) {
                        const cashierUrl = paymentData.clientData?.cashierUrl || paymentData.clientData?.paymentUrl;
                        const sandboxInstructions = paymentData.clientData?.sandboxInstructions;
                        
                        resultContent = `
                            <div class="result-item">
                                <h4><span class="status success">Success</span> UPI Collect Flow Created</h4>
                                <p><strong>Payment ID:</strong> ${paymentData.id}</p>
                                <p><strong>UPI ID:</strong> ${paymentData.clientData?.upiId}</p>
                                <p><strong>Order ID:</strong> ${paymentData.clientData?.orderId}</p>
                                <p><strong>Amount:</strong> ‚Çπ${amount}</p>
                                <p><strong>Status:</strong> Payment intent created successfully</p>
                                
                                ${cashierUrl ? `
                                    <div style="margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                        <h4 style="color: #2e7d32; margin-bottom: 15px;">üéØ Sandbox Testing Instructions</h4>
                                        
                                        <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                            <h5 style="color: #2e7d32; margin-bottom: 10px;">üì± Testing Steps:</h5>
                                            <ol style="margin: 0; padding-left: 20px;">
                                                <li>Click the "Open Paytm Cashier" button below</li>
                                                <li>You will see a QR code/barcode on the screen</li>
                                                <li>Open <strong>PPSL-QR-Scanner</strong> app on your mobile</li>
                                                <li>Scan the QR code/barcode with the app</li>
                                                <li>In the app, select <strong>Approve (Success)</strong> or <strong>Decline (Failure)</strong></li>
                                                <li>Paytm will send webhook to your backend with the result</li>
                                            </ol>
                                        </div>
                                        
                                        <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px; border: 1px solid #dee2e6;">
                                            <h5 style="color: #2e7d32; margin-bottom: 10px;">üöÄ Open Paytm Cashier:</h5>
                                            <button onclick="openPaytmCashier('${paymentData.clientData?.cashierFormData?.action || paymentData.clientData?.cashierUrl || cashierUrl}', '${paymentData.clientData?.cashierFormData?.txnToken || paymentData.clientData?.txnToken || ''}')" 
                                                    style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">
                                                üè¶ Open Paytm Cashier (Modal)
                                            </button>
                                            <p>Cashier URL: ${cashierUrl}</p>
                                            <p style="margin-top: 10px; font-size: 14px; color: #666;">
                                                <strong>Note:</strong> This will properly POST the transaction token to Paytm (not just open a URL)
                                            </p>
                                        </div>
                                        
                                        <div style="background: #fff3cd; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #ffc107;">
                                            <strong>‚ö†Ô∏è Note:</strong> This is sandbox testing. In production, users would receive push notifications on their UPI apps.
                                        </div>
                                        
                                        <div style="background: #d4edda; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #28a745;">
                                            <strong>‚úÖ Fixed:</strong> The "OOPS" error was caused by opening the URL directly instead of POSTing the transaction token.
                                            <br><small>Now using proper POST request with txnToken in the request body.</small>
                                        </div>
                                        
                                        <div style="background: #e7f3ff; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #2196F3;">
                                            <strong>üîç Debug Info:</strong>
                                            <ul style="margin: 5px 0 0 20px; font-size: 14px;">
                                                <li><strong>Cashier URL:</strong> ${paymentData.clientData?.cashierFormData?.action || paymentData.clientData?.cashierUrl || cashierUrl}</li>
                                                <li><strong>TXN Token:</strong> ${paymentData.clientData?.cashierFormData?.txnToken || paymentData.clientData?.txnToken ? 'Present' : 'Missing'}</li>
                                                <li><strong>Form Method:</strong> POST</li>
                                                <li><strong>Endpoint:</strong> showPaymentPage</li>
                                            </ul>
                                        </div>
                                        
                                        <div style="background: #f8d7da; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #dc3545;">
                                            <strong>üêõ If you still get errors:</strong>
                                            <ul style="margin: 5px 0 0 20px; font-size: 14px;">
                                                <li>Clear browser cookies and cache</li>
                                                <li>Try in incognito/private browsing mode</li>
                                                <li>Use a different browser</li>
                                                <li>Check if Paytm sandbox is accessible</li>
                                                <li>Verify transaction token is valid</li>
                                            </ul>
                                        </div>
                                        
                                        ${paymentData.clientData?.isSandbox === false ? `
                                            <div style="background: #d1ecf1; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #17a2b8;">
                                                <strong>üîß Mock Mode:</strong> Paytm sandbox is currently down (503 error). Using mock response for testing.
                                                <br><small>This allows you to test the flow without Paytm sandbox dependency.</small>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                                
                                <details style="margin-top: 15px;">
                                    <summary style="cursor: pointer; font-weight: bold;">üìã View Full Response Data</summary>
                                    <pre style="margin-top: 10px;">${JSON.stringify(data, null, 2)}</pre>
                                </details>
                            </div>
                        `;
                    } else {
                        resultContent = `
                            <div class="result-item error">
                                <h4><span class="status error">Error</span> UPI Collect Flow Data Missing</h4>
                                <p>Response received but UPI Collect Flow data is missing</p>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        `;
                    }
                } else {
                    resultContent = `
                        <div class="result-item error">
                            <h4><span class="status error">Error</span> Payment Creation Failed</h4>
                            <p><strong>Error:</strong> ${data.message || 'Unknown error'}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }

                showResults('paymentResults', resultContent);

            } catch (error) {
                const resultContent = `
                    <div class="result-item error">
                        <h4><span class="status error">Error</span> Network Error</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure your API server is running on ${API_BASE_URL}</p>
                    </div>
                `;
                showResults('paymentResults', resultContent);
            } finally {
                hideSpinner('paymentSpinner');
            }
        }

        // Test Webhook
        async function testWebhook() {
            const orderId = document.getElementById('webhookOrderId').value;
            const txnId = document.getElementById('webhookTxnId').value;
            const amount = document.getElementById('webhookAmount').value;
            const status = document.getElementById('webhookStatus').value;
            const upiId = document.getElementById('webhookUpiId').value;

            showSpinner('webhookSpinner');

            try {
                const webhookPayload = {
                    ORDERID: orderId,
                    TXNID: txnId,
                    TXNAMOUNT: amount,
                    STATUS: status,
                    BANKTXNID: 'BANK_TXN_987654321',
                    TXNDATE: new Date().toISOString(),
                    GATEWAYNAME: 'PAYTM',
                    BANKNAME: 'HDFC',
                    PAYMENTMODE: 'UPI',
                    UPI_ID: upiId,
                    UPITXNID: 'UPI_TXN_456789',
                    UPIREFID: 'UPI_REF_789123',
                    RESPCODE: status === 'TXN_SUCCESS' ? '01' : '02',
                    RESPMSG: status === 'TXN_SUCCESS' ? 'Txn Success' : 'Txn Failed',
                    CHECKSUMHASH: 'mock_checksum_hash'
                };

                const response = await fetch(`${API_BASE_URL}/${API_PREFIX}/payments/webhooks/paytm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookPayload)
                });

                const data = await response.json();
                
                let resultContent = '';
                if (response.ok) {
                    resultContent = `
                        <div class="result-item">
                            <h4><span class="status success">Success</span> Webhook Handled</h4>
                            <p><strong>Order ID:</strong> ${data.orderId || orderId}</p>
                            <p><strong>Status:</strong> ${data.status || status}</p>
                            <p><strong>Provider:</strong> ${data.provider || 'paytm'}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    const isChecksumError = data.message && data.message.includes('Invalid Paytm webhook signature');
                    
                    if (isChecksumError) {
                        resultContent = `
                            <div class="result-item">
                                <h4><span class="status success">Success</span> Webhook Security Working</h4>
                                <p><strong>Note:</strong> Checksum verification is working correctly</p>
                                <p><strong>Expected Behavior:</strong> Rejects invalid checksums for security</p>
                                <p><strong>Error:</strong> ${data.message}</p>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        `;
                    } else {
                        resultContent = `
                            <div class="result-item error">
                                <h4><span class="status error">Error</span> Webhook Failed</h4>
                                <p><strong>Error:</strong> ${data.message || 'Unknown error'}</p>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        `;
                    }
                }

                showResults('webhookResults', resultContent);

            } catch (error) {
                const resultContent = `
                    <div class="result-item error">
                        <h4><span class="status error">Error</span> Network Error</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Make sure your API server is running on ${API_BASE_URL}</p>
                    </div>
                `;
                showResults('webhookResults', resultContent);
            } finally {
                hideSpinner('webhookSpinner');
            }
        }

        // Function to open Paytm cashier with proper POST request
        function openPaytmCashier(actionUrl, txnToken) {
            try {
                console.log('Opening Paytm cashier with POST request...');
                console.log('Action URL:', actionUrl);
                console.log('TXN Token:', txnToken);

                // Create a form element
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = actionUrl;
                form.target = '_blank'; // Open in new tab
                form.style.display = 'none';

                // Add only txnToken field as per Paytm documentation
                if (txnToken) {
                    const txnTokenInput = document.createElement('input');
                    txnTokenInput.type = 'hidden';
                    txnTokenInput.name = 'txnToken';
                    txnTokenInput.value = txnToken;
                    form.appendChild(txnTokenInput);
                }

                // Add form to page and submit
                document.body.appendChild(form);
                form.submit();

                // Clean up
                setTimeout(() => {
                    document.body.removeChild(form);
                }, 1000);

                console.log('‚úÖ Paytm cashier form submitted successfully');

            } catch (error) {
                console.error('‚ùå Error opening Paytm cashier:', error);
                alert('Error opening Paytm cashier: ' + error.message);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('UPI Collect Flow Simulator loaded');
            console.log('API Base URL:', API_BASE_URL);
            console.log('JWT Token:', JWT_TOKEN ? 'Present' : 'Missing');
        });
    </script>
</body>
</html>
